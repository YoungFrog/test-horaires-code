<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js" integrity="sha256-XCdgoNaBjzkUaEJiauEq+85q/xi/2D4NcB3ZHwAapoM=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" integrity="sha256-5veQuRbWaECuYxwap/IOE/DAwNxgm4ikX7nrgsqYp88=" crossorigin="anonymous">
    <link
      href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <script>
      const constraints = [];
      const colonnes = ["aa", "profs", "groupes", "lieux"];
      const selectBoxes = colonnes.map((nom) => ({
        nom,
        nomSelect: nom + "Select",
        values: new Set(),
      }));
      let dataPromise = fetch(
        "https://youngfrog.lavnir.be/test-horaires/events.json"
      );
      let contentLoadedPromise = new Promise(function (res, rej) {
        document.addEventListener("DOMContentLoaded", res, { once: true });
      });
      let calendar; // initialized in setupCalendar

      Promise.all([dataPromise, contentLoadedPromise])
        .then(function ([response]) {
          if (!response.ok) {
            throw new Error("oh no, it's an error. Look: " + response.status);
          }
          return response.json();
        })
        .then(setupCalendar);

      function setupCalendar(rawEvents) {
        let dedupedEvents = new Map();
        console.log("Nombre d'Ã©vt", rawEvents.length);
        const getKey = (evt) => evt.id.split("-").slice(1, 3).join("-");
        rawEvents.forEach((event) => {
          let key = getKey(event);
          if (!dedupedEvents.has(key)) {
            dedupedEvents.set(key, []);
          }
          event.display = "none";
          const { aa, profacros, groupes, lieux } = event;
          event.title = `${aa} -- ${profacros} -- ${groupes} -- ${lieux}`;
          dedupedEvents.get(key).push(event);
        });
        let mergedEvents = [];
        for (let [key, events] of dedupedEvents) {
          let [eventToAdd] = events;
          eventToAdd.groupes = events.map((e) => e.groupes).flat();
          mergedEvents.push(eventToAdd);
        }
        console.log("Deduped: ", mergedEvents.length);
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "timeGridWeek",
          slotMinTime: "08:15:00",
          slotMaxTime: "18:00:00",
          height: "auto",
          allDaySlot: false,
          locale: "fr",
          hiddenDays: [0, 6],
          dayHeaderFormat: { weekday: "short" },
          headerToolbar: {
            start: "prev today next",
            center: "title",
            end: "dayGridMonth timeGridWeek timeGridDay",
          },
          events: mergedEvents,
          eventClick: ({ event }) => console.log(event.extendedProps),
        });
        calendar.render();
        calendar.getEvents().forEach((evt) => {
          const props = evt.extendedProps;

          selectBoxes.forEach(({ nom, values }) => {
            if (typeof props[nom] === "string") values.add(props[nom]);
            else props[nom]?.forEach((elt) => values.add(elt));
          });
        });
        selectBoxes.forEach(({ nomSelect, values }) =>
          addOptionsToSelectSorted(nomSelect, values)
        );
      }
      function addOptionsToSelectSorted(id, values) {
        select = document.getElementById(id);
        let array = [...values];
        array.sort().forEach((val) => {
          let newOpt = document.createElement("option", { name: val });
          newOpt.textContent = val;
          select.appendChild(newOpt);
        });
      }

      function getSelectedValues(id) {
        return Array.prototype.map.call(
          document.getElementById(id).selectedOptions,
          (opt) => opt.value
        );
      }
      function filter() {
        calendar.batchRendering(() => {
          filterEvents(constraints);
        });
      }
      function filterEvents(constraints) {
        calendar.getEvents().forEach((event) => {
          const props = event.extendedProps;
          const shouldDisplay = (constraint) =>
            Object.entries(constraint).every(
              ([eventPropertyName, selectedProperties]) => {
                if (
                  !(
                    selectedProperties?.length &&
                    props[eventPropertyName]?.length
                  )
                )
                  return true;
                else
                  return selectedProperties.some((prop) =>
                    typeof props[eventPropertyName] === "string"
                      ? props[eventPropertyName] === prop
                      : props[eventPropertyName].includes(prop)
                  );
              }
            );
          const newValue = constraints.some(shouldDisplay) ? "auto" : "none";
          if (event.display !== newValue) event.setProp("display", newValue);
        });
      }

      function addConstraint() {
        let constraint = selectBoxes.map(({ nom, nomSelect }) => [
          nom,
          getSelectedValues(nomSelect),
        ]);
        constraints.push(Object.fromEntries(constraint));
        renderConstraints();
        filter();
        unselectAll(".elementsSelect");
      }
      function unselectAll(selector) {
        document.querySelectorAll(selector).forEach((elt) => {
          Array.from(elt.options).forEach((opt) => (opt.selected = false));
        });
      }
      function renderConstraints() {
        let listEl = document.getElementById("constraints");
        removeAllChildNodes(listEl);
        constraints.forEach((constraint, index) => {
          let liEl = document.createElement("li");
          liEl.innerHTML =
            (index > 0 ? "or : " : "") + renderConstraint(constraint);
          listEl.appendChild(liEl);
        });
      }
      function renderConstraint(constraint) {
        let result = "<ul style='flex'>";
        let moreThanOne = false;
        Object.entries(constraint).forEach(([name, wanted], index) => {
          if (wanted?.length) {
            result += `<li>${
              moreThanOne ? " and " : ""
            }${name} must be in ${wanted}</li>`;
            moreThanOne = true;
          }
        });
        return result + "</ul>";
      }
      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }

      function deleteConstraints() {
        constraints.splice(0);
        renderConstraints();
      }
    </script>
  </head>

  <body class="m-3">
    <div class="flex">
      <script>
        selectBoxes.forEach(({ nomSelect }) =>
          document.write(`
                <select id="${nomSelect}"  multiple class="elementsSelect border rounded mr-3 flex-1">
                </select>`)
        );
      </script>
      <button
        onclick="addConstraint()"
        class="bg-blue-300 to-white p-2 m-4 rounded-2xl"
      >
        Ajouter condition
      </button>
    </div>
    <div class="flex">
      <ul id="constraints" class="flex-1"></ul>
      <button
        onclick="filter()"
        class="bg-blue-300 to-white p-2 m-4 rounded-2xl"
      >
        Filtrer!
      </button>
      <button
        onclick="deleteConstraints()"
        class="to-white p-2 m-4 rounded-2xl bg-red-500"
      >
        Effacer les contraintes!
      </button>
    </div>
    <div id="calendar"></div>
  </body>
</html>
